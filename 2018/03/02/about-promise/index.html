<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="翻译,JavaScript,Promise," />








  <link rel="shortcut icon" type="image/x-icon" href="http://oux6kzfrp.bkt.clouddn.com/aoteman.jpg?v=5.1.2" />






<meta name="description" content="原文地址：9 Promising Promise Tips 原文作者：Kushan Joshi 译文出自：掘金翻译计划 本文永久链接：https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md 译者：position_柚子君 校对者：Starrier, DukeWu   关于 Promise 的 9">
<meta name="keywords" content="翻译,JavaScript,Promise">
<meta property="og:type" content="article">
<meta property="og:title" content="关于 Promise 的 9 个提示">
<meta property="og:url" content="http://yanmeng.me/2018/03/02/about-promise/index.html">
<meta property="og:site_name" content="position_柚子君">
<meta property="og:description" content="原文地址：9 Promising Promise Tips 原文作者：Kushan Joshi 译文出自：掘金翻译计划 本文永久链接：https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md 译者：position_柚子君 校对者：Starrier, DukeWu   关于 Promise 的 9">
<meta property="og:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png">
<meta property="og:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--gf5-9vXv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36400725-dac92186-15a0-11e8-8b4f-6a344e6a5229.png">
<meta property="og:updated_time" content="2018-03-02T14:35:03.291Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于 Promise 的 9 个提示">
<meta name="twitter:description" content="原文地址：9 Promising Promise Tips 原文作者：Kushan Joshi 译文出自：掘金翻译计划 本文永久链接：https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md 译者：position_柚子君 校对者：Starrier, DukeWu   关于 Promise 的 9">
<meta name="twitter:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yanmeng.me/2018/03/02/about-promise/"/>





  <title>关于 Promise 的 9 个提示 | position_柚子君</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f504c7f6160a763bcac725ebe10164ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">position_柚子君</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yanmeng.me/2018/03/02/about-promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Meng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oux6kzfrp.bkt.clouddn.com/blog/avatarIMG_3716.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="position_柚子君">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">关于 Promise 的 9 个提示</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-02T22:31:36+08:00">
                2018-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/02/about-promise/" class="leancloud_visitors" data-flag-title="关于 Promise 的 9 个提示">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o">本文总阅读量</i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<ul>
<li>原文地址：<a href="https://dev.to/kepta/promising-promise-tips--c8f" target="_blank" rel="external">9 Promising Promise Tips</a></li>
<li>原文作者：<a href="https://dev.to/kepta" target="_blank" rel="external">Kushan Joshi</a></li>
<li>译文出自：<a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">掘金翻译计划</a></li>
<li>本文永久链接：<a href="https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md" target="_blank" rel="external">https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md</a></li>
<li>译者：<a href="https://github.com/yanyixin" target="_blank" rel="external">position_柚子君</a></li>
<li>校对者：<a href="https://github.com/Starriers" target="_blank" rel="external">Starrier</a>, <a href="https://github.com/94haox" target="_blank" rel="external">DukeWu</a></li>
</ul>
</blockquote>
<h1 id="关于-Promise-的-9-个提示"><a href="#关于-Promise-的-9-个提示" class="headerlink" title="关于 Promise 的 9 个提示"></a>关于 Promise 的 9 个提示</h1><p>正如同事所说的那样，Promise 在工作中表现优异。</p>
<p><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png" alt="prom"></p>
<p>这篇文章会给你一些如何改善与 Promise 之间关系的建议。</p>
<a id="more"></a>
<h2 id="1-你可以在-then-里面-return-一个-Promise"><a href="#1-你可以在-then-里面-return-一个-Promise" class="headerlink" title="1. 你可以在 .then 里面 return 一个 Promise"></a>1. 你可以在 .then 里面 return 一个 Promise</h2><p>让我来说明这最重要的一点</p>
<blockquote>
<p><strong>是的！你可以在 .then 里面 return 一个 Promise</strong></p>
</blockquote>
<p>而且，return 的这个 Promise 将在下一个 <code>.then</code> 中自动解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.then(r =&gt; &#123;</div><div class="line">    return serverStatusPromise(r); // 返回 &#123; statusCode: 200 &#125; 的 Promise</div><div class="line">&#125;)</div><div class="line">.then(resp =&gt; &#123;</div><div class="line">    console.log(resp.statusCode); // 200; 注意自动解析的 promise</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="2-每次执行-then-的时候都会自动创建一个新的-Promise"><a href="#2-每次执行-then-的时候都会自动创建一个新的-Promise" class="headerlink" title="2. 每次执行 .then 的时候都会自动创建一个新的 Promise"></a>2. 每次执行 .then 的时候都会自动创建一个新的 Promise</h2><p>如果熟悉 javascript 的链式风格，那么你应该会感到很熟悉。但是对于一个初学者来说，可能就不会了。</p>
<p>在 Promise 中不论你使用 <code>.then</code> 或者 <code>.catch</code> 都会创建一个新的 Promise。这个 Promise 是刚刚链式调用的 Promise 和 刚刚加上的 <code>.then</code> / <code>.catch</code> 的组合。</p>
<p>让我们来看一个 🌰：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var statusProm = fetchServerStatus();</div><div class="line"></div><div class="line">var promA = statusProm.then(r =&gt; (r.statusCode === 200 ? &quot;good&quot; : &quot;bad&quot;));</div><div class="line"></div><div class="line">var promB = promA.then(r =&gt; (r === &quot;good&quot; ? &quot;ALL OK&quot; : &quot;NOTOK&quot;));</div><div class="line"></div><div class="line">var promC = statusProm.then(r =&gt; fetchThisAnotherThing());</div></pre></td></tr></table></figure>
<p>上面 Promise 的关系可以在流程图中清晰的描述出来：<br><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--gf5-9vXv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36400725-dac92186-15a0-11e8-8b4f-6a344e6a5229.png" alt="image"></p>
<p>需要特别注意的是 <code>promA</code>、 <code>promB</code> 和 <code>promC</code> 全部都是不同的但是有关联的 Promise。</p>
<p>我喜欢把 <code>.then</code> 想像成一个大型管道，当上游节点出现问题时，水就会停止流向下游。例如，如果 <code>promB</code> 失败，下游节点不会受到影响，但是如果 <code>statusProm</code> 失败，那么下游的所有节点都将受到影响，即 <code>rejected</code>。</p>
<h2 id="3-对调用者来说，Promise-的-resolved-rejected-状态是唯一的"><a href="#3-对调用者来说，Promise-的-resolved-rejected-状态是唯一的" class="headerlink" title="3. 对调用者来说，Promise 的 resolved/rejected 状态是唯一的"></a>3. 对调用者来说，<code>Promise</code> 的 <code>resolved/rejected</code> 状态是唯一的</h2><p>我认为这个是让 Promise 好好运行的最重要的事情之一。简单来说，如果在你的应用中 Promise 在很多不同的模块之间共享，那么当 Promise 返回 <code>resolved/rejected</code> 状态时，所有的调用者都会收到通知。</p>
<blockquote>
<p>这也意味着没有人可以改变你的 Promise，所以可以放心的把它传递出去。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function yourFunc() &#123;</div><div class="line">  const yourAwesomeProm = makeMeProm();</div><div class="line"></div><div class="line">  yourEvilUncle(yourAwesomeProm); // 无论 Promise 受到了怎样的影响，它最终都会成功执行</div><div class="line"></div><div class="line">  return yourAwesomeProm.then(r =&gt; importantProcessing(r));</div><div class="line">&#125;</div><div class="line"></div><div class="line">function yourEvilUncle(prom) &#123;</div><div class="line">  return prom.then(r =&gt; Promise.reject(&quot;destroy!!&quot;)); // 可能遭受的影响</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的例子可以看出，Promise 的设计使得自身很难被改变。正如我上面所说的：”保持冷静，并将 Promise 传递下去”。</p>
<h2 id="4-Promise-构造函数不是解决方案"><a href="#4-Promise-构造函数不是解决方案" class="headerlink" title="4. Promise 构造函数不是解决方案"></a>4. Promise 构造函数不是解决方案</h2><p>我看到很多开发者喜欢用构造函数的风格，他们认为这就是 Promise 的方式。但这却是一个谎言，实际的原因是构造函数 API 和之前回调函数的 API 相似，而且这样的习惯很难改变。</p>
<blockquote>
<p><strong>如果你发现自己正在到处使用 <code>Promise 构造函数</code>，那你的做法是错的！</strong></p>
</blockquote>
<p>要真正的向前迈进一步并且摆脱回调，你需要小心谨慎并且最小程度地使用 Promise 构造函数。</p>
<p>让我们看一下使用 <code>Promise 构造函数</code> 的具体情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">return new Promise((res, rej) =&gt; &#123;</div><div class="line">  fs.readFile(&quot;/etc/passwd&quot;, function(err, data) &#123;</div><div class="line">    if (err) return rej(err);</div><div class="line">    return res(data);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>Promise 构造函数</code> 应该<strong>只在你想要把回调转换成 Promise 时使用</strong>。<br>一旦你掌握了这种创建 Promise 的优雅方式，它将会变的非常有吸引力。</p>
<p>让我们看一下冗余的 <code>Promise 构造函数</code>。</p>
<p>☠️<strong>错误的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">return new Promise((res, rej) =&gt; &#123;</div><div class="line">    var fetchPromise = fetchSomeData(.....);</div><div class="line">    fetchPromise</div><div class="line">        .then(data =&gt; &#123;</div><div class="line">            res(data); // 错误！！！</div><div class="line">        &#125;)</div><div class="line">        .catch(err =&gt; rej(err))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>💖<strong>正确的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return fetchSomeData(...); // 正确的！</div></pre></td></tr></table></figure>
<p>用 <code>Promise 构造函数</code> 封装 Promise 是<strong>多余的，并且违背了 Promise 本身的目的</strong>。</p>
<p>😎<strong>高级技巧</strong></p>
<p>如果你是一个 <strong>nodejs</strong> 开发者，我建议你可以看一看 <a href="http://2ality.com/2017/05/util-promisify.html" target="_blank" rel="external">util.promisify</a>。这个方法可以帮助你把 node 风格的回调转换为 Promise。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">const &#123;promisify&#125; = require(&apos;util&apos;);</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line"></div><div class="line">const readFileAsync = promisify(fs.readFile);</div><div class="line"></div><div class="line">readFileAsync(&apos;myfile.txt&apos;, &apos;utf-8&apos;)</div><div class="line">  .then(r =&gt; console.log(r))</div><div class="line">  .catch(e =&gt; console.error(e));</div></pre></td></tr></table></figure>
<p></p>
<h2 id="5-使用-Promise-resolve"><a href="#5-使用-Promise-resolve" class="headerlink" title="5. 使用 Promise.resolve"></a>5. 使用 Promise.resolve</h2><p>Javascript 提供了 <code>Promise.resolve</code> 方法，像下面的例子这样简洁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var similarProm = new Promise(res =&gt; res(5));</div><div class="line">// ^^ 等价于</div><div class="line">var prom = Promise.resolve(5);</div></pre></td></tr></table></figure>
<p>它有多种使用情况，我最喜欢的一种是可以把普通的（异步的）js 对象转化成 Promise。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 将同步函数转换为异步函数</div><div class="line">function foo() &#123;</div><div class="line">  return Promise.resolve(5);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当不确定它是一个 Promise 还是一个普通的值的时候，你也可以做一个安全的封装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function goodProm(maybePromise) &#123;</div><div class="line">  return Promise.resolve(maybePromise);</div><div class="line">&#125;</div><div class="line"></div><div class="line">goodProm(5).then(console.log); // 5</div><div class="line"></div><div class="line">var sixPromise = fetchMeNumber(6);</div><div class="line"></div><div class="line">goodProm(sixPromise).then(console.log); // 6</div><div class="line"></div><div class="line">goodProm(Promise.resolve(Promise.resolve(5))).then(console.log); // 5, 注意，它会自动解析所有的 Promise！</div></pre></td></tr></table></figure>
<h2 id="6-使用-Promise-reject"><a href="#6-使用-Promise-reject" class="headerlink" title="6.使用 Promise.reject"></a>6.使用 Promise.reject</h2><p>Javascript 也提供了 <code>Promise.reject</code> 方法。像下面的例子这样简洁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var rejProm = new Promise((res, reject) =&gt; reject(5));</div><div class="line"></div><div class="line">rejProm.catch(e =&gt; console.log(e)) // 5</div></pre></td></tr></table></figure>
<p>我最喜欢的用法是提前使用 <code>Promise.reject</code> 来拒绝。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">function foo(myVal) &#123;</div><div class="line">    if (!mVal) &#123;</div><div class="line">        return Promise.reject(new Error(&apos;myVal is required&apos;))</div><div class="line">    &#125;</div><div class="line">    return new Promise((res, rej) =&gt; &#123;</div><div class="line">        // 从你的大回调到 Promise 的转换！</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单来说，使用 <code>Promise.reject</code> 可以拒绝任何你想要拒绝的 Promise。</p>
<p>在下面的例子中，我在 <code>.then</code> 里面使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.then(val =&gt; &#123;</div><div class="line">  if (val != 5) &#123;</div><div class="line">    return Promise.reject(&apos;Not Good&apos;);</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; console.log(e)) // 这样是不好的</div></pre></td></tr></table></figure>
<p><strong>注意：你可以像 <code>Promise.resolve</code> 一样在 <code>Promise.reject</code> 中传递任何值。你经常在失败的 Promise 中发现 <code>Error</code> 的原因是因为它主要就是用来抛出一个异步错误的。</strong></p>
<h2 id="7-使用-Promise-all"><a href="#7-使用-Promise-all" class="headerlink" title="7. 使用 Promise.all"></a>7. 使用 Promise.all</h2><p>Javascript 提供了 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="external">Promise.all</a> 方法。像 … 这样的简洁，好吧，我想不出来例子了😁。</p>
<p>在伪算法中，<code>Promise.all</code> 可以被概括为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">接收一个 Promise 数组</div><div class="line"></div><div class="line">    然后同时运行他们</div><div class="line"></div><div class="line">    然后等到他们全部运行完成</div><div class="line"></div><div class="line">    然后 return 一个新的 Promise 数组</div><div class="line"></div><div class="line">    他们其中有一个失败或者 reject，都可以被捕获。</div></pre></td></tr></table></figure>
<p>下面的例子展示了所有的 Promise 完成的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">var prom1 = Promise.resolve(5);</div><div class="line">var prom2 = fetchServerStatus(); // 返回 &#123;statusCode: 200&#125; 的 Promise</div><div class="line"></div><div class="line">Proimise.all([prom1, prom2])</div><div class="line">.then([val1, val2] =&gt; &#123; // 注意，这里被解析成一个数组</div><div class="line">    console.log(val1); // 5</div><div class="line">    console.log(val2.statusCode); // 200</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>下面的例子展示了当他们其中一个失败的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var prom1 = Promise.reject(5);</div><div class="line">var prom2 = fetchServerStatus(); // 返回 &#123;statusCode: 200&#125; 的 Promise</div><div class="line"></div><div class="line">Proimise.all([prom1, prom2])</div><div class="line">.then([val1, val2] =&gt; &#123;</div><div class="line">    console.log(val1); </div><div class="line">    console.log(val2.statusCode); </div><div class="line">&#125;)</div><div class="line">.catch(e =&gt;  console.log(e)) // 5, 直接跳转到 .catch</div></pre></td></tr></table></figure>
<p><strong>注意：<code>Promise.all</code> 是很聪明的！如果其中一个 Promise 失败了，它不会等到所有的 Promise 完成，而是立即中止！</strong></p>
<h2 id="8-不要害怕-reject，也不要在每个-then-后面加冗余的-catch"><a href="#8-不要害怕-reject，也不要在每个-then-后面加冗余的-catch" class="headerlink" title="8. 不要害怕 reject，也不要在每个 .then 后面加冗余的 .catch"></a>8. 不要害怕 reject，也不要在每个 .then 后面加冗余的 <code>.catch</code></h2><p>我们是不是会经常担心错误会在它们之间的某处被吞噬？</p>
<p>为了克服这个恐惧，这里有一个简单的小提示：</p>
<blockquote>
<p><strong>让 reject 来处理上游函数的问题。</strong></p>
</blockquote>
<p>在理想的情况下，reject 方法应该是应用的根源，所有的 reject 都会向下传递。</p>
<p><strong>不要害怕像下面这样写</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return fetchSomeData(...);</div></pre></td></tr></table></figure>
<p>现在如果你想要处理函数中 reject 的情况，请决定是解决问题还是继续 reject。</p>
<p>💘 <strong>解决 reject</strong></p>
<p>解决 reject 是很简单的，在 <code>.catch</code> 不论你返回什么内容，都将被假定为已解决的。然而，如果你在 <code>.catch</code> 中返回 <code>Promise.reject</code>，那么这个 Promise 将会是失败的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">.then(() =&gt; 5.length) // &lt;-- 这里会报错</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">        return 5;  // &lt;-- 重新使方法正常运行</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; &#123;</div><div class="line">    console.log(r); // 5</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">    console.error(e); // 这个方法永远不会被调用 :)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>💔<strong>拒绝一个 reject</strong></p>
<p>拒绝一个 reject 是简单的。<strong>不需要做任何事情。</strong> 就像我刚刚说的，让它成为其他函数的问题。通常情况下，父函数有比当前函数处理 reject 更好的方法。</p>
<p>需要记住的重要的一点是，一旦你写了 catch 方法，就意味着你正在处理这个错误。这个和同步 <code>try/catch</code>的工作方式相似。</p>
<p>如果你确实想要拦截一个 reject：（我强烈建议不要这样做！）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.then(() =&gt; 5.length) // &lt;-- 这里会报错</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">  errorLogger(e); // 做一些错误处理</div><div class="line">  return Promise.reject(e); // 拒绝它，是的，你可以这么做！</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; &#123;</div><div class="line">    console.log(r); // 这个 .then (或者任何后面的 .then) 将永远不会被调用，因为我们在上面使用了 reject :)</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">    console.error(e); //&lt;-- 它变成了这个 catch 方法的问题</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>.then(x,y) 和 then(x).catch(x) 之间的分界线</strong></p>
<p><code>.then</code> 接收的第二个回调函数参数也可以用来处理错误。它和 <code>then(x).catch(x)</code> 看起来很像，但是他们处理错误的区别在于他们自身捕获的错误。</p>
<p>我会用下面的例子来说明这一点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.then(function() &#123;</div><div class="line">   return Promise.reject(new Error(&apos;something wrong happened&apos;));</div><div class="line">&#125;).catch(function(e) &#123;</div><div class="line">   console.error(e); // something wrong happened</div><div class="line">&#125;);</div><div class="line"></div><div class="line">.then(function() &#123;</div><div class="line">   return Promise.reject(new Error(&apos;something wrong happened&apos;));</div><div class="line">&#125;, function(e) &#123; // 这个回调处理来自当前 `.then` 方法之前的错误</div><div class="line">    console.error(e); // 没有错误被打印出来</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当你想要处理的是来自上游 Promise 而不是刚刚在 <code>.then</code> 里面加上去的错误的时候， <code>.then(x,y)</code> 变的很方便。</p>
<p>提示: 99.9% 的情况使用简单的 <code>then(x).catch(x)</code> 更好。</p>
<h2 id="9-避免-then-回调地狱"><a href="#9-避免-then-回调地狱" class="headerlink" title="9. 避免 .then 回调地狱"></a>9. 避免 .then 回调地狱</h2><p>这个提示是相对简单的，尽量避免 <code>.then</code> 里包含 <code>.then</code> 或者 <code>.catch</code>。相信我，这比你想象的更容易避免。</p>
<p>☠️<strong>错误的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">request(opts)</div><div class="line">.catch(err =&gt; &#123;</div><div class="line">  if (err.statusCode === 400) &#123;</div><div class="line">    return request(opts)</div><div class="line">           .then(r =&gt; r.text())</div><div class="line">           .catch(err2 =&gt; console.error(err2))</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>💖<strong>正确的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">request(opts)</div><div class="line">.catch(err =&gt; &#123;</div><div class="line">  if (err.statusCode === 400) &#123;</div><div class="line">    return request(opts);</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; r.text())</div><div class="line">.catch(err =&gt; console.erro(err));</div></pre></td></tr></table></figure>
<p>有些时候我们在 <code>.then</code> 里面需要很多变量，那就别无选择了，只能再创建一个 <code>.then</code> 方法链。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.then(myVal =&gt; &#123;</div><div class="line">    const promA = foo(myVal);</div><div class="line">    const promB = anotherPromMake(myVal);</div><div class="line">    return promA</div><div class="line">          .then(valA =&gt; &#123;</div><div class="line">              return promB.then(valB =&gt; hungryFunc(valA, valB)); // 很丑陋!</div><div class="line">          &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>我推荐使用 ES6 的解构方法混合着 <code>Promise.all</code> 方法就可以解决这个问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.then(myVal =&gt; &#123;</div><div class="line">    const promA = foo(myVal);</div><div class="line">    const promB = anotherPromMake(myVal);</div><div class="line">    return Promise.all([prom, anotherProm])</div><div class="line">&#125;)</div><div class="line">.then(([valA, valB]) =&gt; &#123;   // 很好的使用 ES6 解构</div><div class="line">    console.log(valA, valB) // 所有解析后的值</div><div class="line">    return hungryFunc(valA, valB)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>注意：如果你的 node/浏览器/老板/意识允许，还可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="external">async/await</a> 方法来解决这个问题。</p>
<p><strong>我真心希望这篇文章对你理解 Promise 有所帮助。</strong></p>
<p>请查看我之前的博客文章。</p>
<ul>
<li><a href="https://dev.to/kepta/a-toddlers-guide-to-memory-leaks-in-javascript-25lf" target="_blank" rel="external">一个初学者指导 Javascript 内存泄漏问题</a></li>
<li><a href="https://dev.to/kepta/understanding-default-parameters-in-javascript-ali" target="_blank" rel="external">了解 Javascript 中的默认参数</a></li>
</ul>
<p>如果你 ❤️ 这篇文章，请分享这篇文章来传播它。</p>
<p>在 Twitter 上联系我 <a href="https://twitter.com/kushan2020" target="_blank" rel="external">@kushan2020</a>。</p>
<hr>
<blockquote>
<p><a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a href="https://juejin.im" target="_blank" rel="external">掘金</a> 上的英文分享文章。内容覆盖 <a href="https://github.com/xitu/gold-miner#android" target="_blank" rel="external">Android</a>、<a href="https://github.com/xitu/gold-miner#ios" target="_blank" rel="external">iOS</a>、<a href="https://github.com/xitu/gold-miner#前端" target="_blank" rel="external">前端</a>、<a href="https://github.com/xitu/gold-miner#后端" target="_blank" rel="external">后端</a>、<a href="https://github.com/xitu/gold-miner#区块链" target="_blank" rel="external">区块链</a>、<a href="https://github.com/xitu/gold-miner#产品" target="_blank" rel="external">产品</a>、<a href="https://github.com/xitu/gold-miner#设计" target="_blank" rel="external">设计</a>、<a href="https://github.com/xitu/gold-miner#人工智能" target="_blank" rel="external">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">掘金翻译计划</a>、<a href="http://weibo.com/juejinfanyi" target="_blank" rel="external">官方微博</a>、<a href="https://zhuanlan.zhihu.com/juejinfanyi" target="_blank" rel="external">知乎专栏</a>。</p>
</blockquote>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>支持原创</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="http://oux6kzfrp.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1.jpeg" alt="Meng Yan WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://oux6kzfrp.bkt.clouddn.com/%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BA%8C%E7%BB%B4%E7%A0%81.jpeg" alt="Meng Yan Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/翻译/" rel="tag"># 翻译</a>
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
            <a href="/tags/Promise/" rel="tag"># Promise</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/07/react-native-run-ios/" rel="next" title="探索一个 React Native 应用是如何启动的 — Ios 篇">
                <i class="fa fa-chevron-left"></i> 探索一个 React Native 应用是如何启动的 — Ios 篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/05/react-best-practices/" rel="prev" title="未遵守 react 最佳实践而引发的 Bug">
                未遵守 react 最佳实践而引发的 Bug <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oux6kzfrp.bkt.clouddn.com/blog/avatarIMG_3716.JPG"
               alt="Meng Yan" />
          <p class="site-author-name" itemprop="name">Meng Yan</p>
           
              <p class="site-description motion-element" itemprop="description">前端，JavaScript，CSS，生活，小女生</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yanyixin" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/2863604000/profile?topnav=1&wvr=6" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      微博
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/meng-meng-75-61-6/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      知乎
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://juejin.im/user/57221ca41532bc00624a1d0a" target="_blank" title="掘金">
                  
                    <i class="fa fa-fw fa-angle-double-down"></i>
                  
                    
                      掘金
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#关于-Promise-的-9-个提示"><span class="nav-number">1.</span> <span class="nav-text">关于 Promise 的 9 个提示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-你可以在-then-里面-return-一个-Promise"><span class="nav-number">1.1.</span> <span class="nav-text">1. 你可以在 .then 里面 return 一个 Promise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-每次执行-then-的时候都会自动创建一个新的-Promise"><span class="nav-number">1.2.</span> <span class="nav-text">2. 每次执行 .then 的时候都会自动创建一个新的 Promise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-对调用者来说，Promise-的-resolved-rejected-状态是唯一的"><span class="nav-number">1.3.</span> <span class="nav-text">3. 对调用者来说，Promise 的 resolved/rejected 状态是唯一的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Promise-构造函数不是解决方案"><span class="nav-number">1.4.</span> <span class="nav-text">4. Promise 构造函数不是解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-使用-Promise-resolve"><span class="nav-number">1.5.</span> <span class="nav-text">5. 使用 Promise.resolve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-使用-Promise-reject"><span class="nav-number">1.6.</span> <span class="nav-text">6.使用 Promise.reject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-使用-Promise-all"><span class="nav-number">1.7.</span> <span class="nav-text">7. 使用 Promise.all</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-不要害怕-reject，也不要在每个-then-后面加冗余的-catch"><span class="nav-number">1.8.</span> <span class="nav-text">8. 不要害怕 reject，也不要在每个 .then 后面加冗余的 .catch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-避免-then-回调地狱"><span class="nav-number">1.9.</span> <span class="nav-text">9. 避免 .then 回调地狱</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Meng Yan</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user">本站访客数</i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye">本站总访问量</i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("IHTzpb0fC94ev9hG4fQa60fR-gzGzoHsz", "wkXHDvgJLdiWePOmQmfWorPf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
